name: Update Windows ISO Links

# 每天自动执行一次 + 手动触发
on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 00:00 执行
  workflow_dispatch:  # 手动触发

permissions:
  contents: write  # 允许 workflow push 回仓库

jobs:
  fetch-fido:
    runs-on: windows-latest

    steps:
      # 1. 检出自己的仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 下载最新 Fido.ps1
      - name: Download Fido.ps1
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/pbatard/Fido/master/Fido.ps1" -OutFile "Fido.ps1"

      # 3. 执行 Fido.ps1 并把输出保存到文件
      - name: Run Fido.ps1 and save output
        shell: pwsh
        run: |
          Write-Host "Fetching Windows 11 ISO link..."
          $link = & ".\Fido.ps1" -Win 'Windows 11' -Rel Latest -Ed 'Windows 11 Home/Pro/Edu' -Lang English -Arch x64 -GetUrl
          Write-Host "Got link: $link"
          $link | Out-File -FilePath "windows_iso_links.txt" -Encoding UTF8

      # 4. 抓取微软官方网页获取 English 64-bit SHA256
      - name: Fetch Microsoft official SHA256
        shell: pwsh
        run: |
          $url = "https://www.microsoft.com/en-us/software-download/windows11"
          $html = Invoke-WebRequest $url
          if ($html.Content -match '<td>English 64-bit</td><td>([A-F0-9]{64})</td>') {
              # Convert SHA256 to lowercase for later checksum comparison
              $sha256 = $matches[1].ToLower()
              Write-Host "English 64-bit SHA256: $sha256"
              $sha256 | Out-File -FilePath "sha256.txt" -Encoding UTF8
          } else {
              Write-Error "Failed to parse SHA256"
          }

      # 5. 获取 ISO 文件大小（MB）
      - name: Fetch ISO size
        shell: pwsh
        run: |
          $link = Get-Content "windows_iso_links.txt"
          $response = Invoke-WebRequest -Uri $link -Method Head

          $cl = $response.Headers["Content-Length"]
          # Content-Length may sometimes be returned as a string array (System.String[]),  
          # so pick the first element to ensure it can be safely converted to Int64.
          if ($cl -is [array]) { $cl = $cl[0] }
          $sizeBytes = [int64]$cl
          $sizeMB = [math]::Ceiling($sizeBytes / 1MB)
          Write-Host "ISO Size (MB): $sizeMB"
          $sizeMB | Out-File -FilePath "size_mb.txt" -Encoding UTF8

      # 6. 整合三个值并输出 JSON 文件，方便脚本统一读取
      - name: Combine all info into one JSON file
        shell: pwsh
        run: |
          $link = Get-Content "windows_iso_links.txt"
          $sha256 = Get-Content "sha256.txt"
          $sizeMB = Get-Content "size_mb.txt"

          $json = [PSCustomObject]@{
              download_link = $link
              sha256 = $sha256
              size_mb = $sizeMB
              updated_at = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
          } | ConvertTo-Json -Depth 3

          $json | Out-File -FilePath "win11_info.json" -Encoding UTF8
 
      # 7. 提交更新到仓库
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update Win11 link, SHA256 & size"
          # ">" means folded block style — it converts the following multiple lines
          # into a single space-separated string so git-auto-commit-action receives them correctly.
          file_pattern: >
            # windows_iso_links.txt
            # sha256.txt
            # size_mb.txt
            win11_info.json
