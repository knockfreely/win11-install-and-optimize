name: Update Windows ISO Links

# 每天自动执行一次 + 手动触发
on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 00:00 执行
  workflow_dispatch:  # 手动触发

permissions:
  contents: write  # 允许 workflow push 回仓库

jobs:
  fetch-fido:
    runs-on: windows-latest

    steps:
      # 1. 检出自己的仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 下载最新 Fido.ps1
      - name: Download Fido.ps1
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/pbatard/Fido/master/Fido.ps1" -OutFile "Fido.ps1"

      # 3. 执行 Fido.ps1 并把输出保存到文件
      - name: Run Fido.ps1 and save output
        shell: pwsh
        run: |
          Write-Host "Fetching Windows 11 ISO link..."
          $link = & ".\Fido.ps1" -Win 'Windows 11' -Rel Latest -Ed 'Windows 11 Home/Pro/Edu' -Lang English -Arch x64 -GetUrl
          Write-Host "Got link: $link"
          $link | Out-File -FilePath "windows_iso_links.txt" -Encoding UTF8

      # 4. 抓取微软官方网页获取 English 64-bit SHA256
      - name: Fetch Microsoft official SHA256
        shell: pwsh
        run: |
          $url = "https://www.microsoft.com/en-us/software-download/windows11"
          $html = Invoke-WebRequest $url
          if ($html.Content -match '<td>English 64-bit</td><td>([A-F0-9]{64})</td>') {
              $sha256 = $matches[1]
              Write-Host "English 64-bit SHA256: $sha256"
              $sha256 | Out-File -FilePath "sha256.txt" -Encoding UTF8
          } else {
              Write-Error "Failed to parse SHA256"
          }

      # 5. 提交更新到仓库
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update Windows 11 ISO link and SHA256 via Fido"
          file_pattern: |
      windows_iso_links.txt
      sha256.txt
